{% extends "admin/change_form.html" %}

{% block extrahead %}
{{ block.super }}
<style>
    #id_failure_category {
        width: 100%;
    }
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const machineField = document.getElementById('id_machine');
    const categoryField = document.getElementById('id_failure_category');
    
    if (!machineField || !categoryField) return;
    
    // Store original options
    const originalOptions = Array.from(categoryField.options).map(opt => ({
        value: opt.value,
        text: opt.text,
        machineType: opt.getAttribute('data-machine-type') || ''
    }));
    
    function filterCategories() {
        const machineId = machineField.value;
        
        if (!machineId) {
            // Reset to all options
            categoryField.innerHTML = '<option value="">---------</option>';
            originalOptions.forEach(opt => {
                if (opt.value) {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.text = opt.text;
                    categoryField.appendChild(option);
                }
            });
            return;
        }
        
        // Get the machine type from data attribute
        const machineOption = machineField.options[machineField.selectedIndex];
        const machineType = machineOption.getAttribute('data-machine-type');
        
        if (!machineType) return;
        
        // Filter and rebuild options
        categoryField.innerHTML = '<option value="">---------</option>';
        originalOptions.forEach(opt => {
            if (!opt.value) return; // Skip empty option
            
            if (opt.machineType === machineType) {
                const option = document.createElement('option');
                option.value = opt.value;
                option.text = opt.text;
                option.setAttribute('data-machine-type', opt.machineType);
                categoryField.appendChild(option);
            }
        });
    }
    
    machineField.addEventListener('change', filterCategories);
});
</script>
{% endblock %}